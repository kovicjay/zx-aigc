2025-09-10: 初始化项目
- 新增 `main.py`：Tkinter GUI、目录扫描、占位符替换、调用ComfyUI、移动完成、日志与休眠
- 新增 `requirements.txt`：requests 依赖
- 新增 `README.md`：使用说明与占位符文档
2025-09-10: 扩展图片类型判断
- 目录扫描支持`.jpeg/.png/.webp`（大小写不敏感）
2025-09-10: 提交工作流容错
- 自动将纯图形包裹为`{"prompt": ...}`并附加`client_id`
- 400错误时输出服务端返回文本，便于定位
2025-09-10: 增加失败处理与超时
- 检测到ComfyUI错误或超时后，移入`失败/`目录并记录到`run.log`
- 成功则移入`完成/`目录，避免卡住单个异常任务
2025-09-10: 支持自定义client_id并固定发送结构
- GUI新增`client_id`输入框
- 提交时强制结构为`{"client_id": <值>, "prompt": {...}}`

2025-09-10: 调整提交方式与兼容重试
- `submit_workflow` 改为优先使用 raw body 发送（`Content-Type: application/json`），
  若返回 400/415 或非成功，则回退一次 `json=payload` 方式重试。
  目的：与 Apifox 在同一工作流下成功、而程序失败的问题保持一致行为，
  兼容部分反代/服务器对请求体解析的差异。

2025-09-10: 为所有请求添加 User-Agent
- 统一在 `ComfyClient` 设置 `User-Agent: p-run/1.0 (+ComfyUI client)`，
  覆盖提交与轮询请求，便于服务器侧识别与诊断。

2025-09-11: 新增负面提示词占位符
- 新增 `{{NEGATIVE_PROMPT}}` 占位符，从项目目录/大模型/负面提示词.txt 读取内容；
- 修正大模型名称获取逻辑，排除负面提示词.txt 文件，避免提取错误；
- 更新占位符提示信息，说明所有可用占位符。

2025-09-11: 新增TOKEN身份验证功能
- 基于MAC地址生成TOKEN，使用HMAC-SHA256算法确保安全性；
- 程序启动时显示TOKEN输入对话框，验证通过后才能使用；
- 支持调试模式（设置环境变量DEBUG=1）显示TOKEN生成按钮；
- 验证失败时提示错误，验证成功后方可进入主界面。

2025-09-11: 新增TOKEN时间限制功能
- TOKEN包含过期时间戳，支持设置有效期（默认30天）；
- 验证时检查TOKEN是否过期，过期则拒绝访问；
- 新增TOKEN生成器对话框，支持自定义有效期（7天/30天/90天/365天）；
- TOKEN使用Base64编码，包含MAC地址、过期时间和HMAC签名；
- 提供TOKEN信息查看和复制功能，便于管理和分发。

2025-09-11: DEBUG模式跳过TOKEN验证
- 设置环境变量DEBUG=1时，程序启动时跳过TOKEN验证直接进入主界面；
- 便于开发和测试，避免每次都需要输入TOKEN；
- 生产环境仍需要TOKEN验证确保安全性。

2025-09-11: 优化DEBUG模式标记
- 新增DEBUG_MODE常量标记，统一管理调试模式状态；
- 替换所有os.getenv("DEBUG")调用，提高代码可读性；
- 便于后续维护和扩展调试功能。

2025-09-11: 完善DEBUG模式TOKEN管理
- DEBUG模式下完全跳过TOKEN验证，直接进入主界面；
- 新增主界面"TOKEN管理"按钮（仅DEBUG模式显示）；
- 创建专业TOKEN管理器对话框，包含生成和验证两个选项卡；
- 支持TOKEN生成、验证、复制等完整功能，便于调试和测试。

2025-09-11: 新增配置文件系统
- 创建 `config.env` 配置文件，支持设置环境变量和默认参数；
- 新增 `load_config.py` 配置加载器，自动加载配置文件；
- 支持DEBUG模式、ComfyUI地址、项目目录、超时时间等配置项；
- 程序启动时自动加载配置，无需修改代码即可调整行为；
- 新增 `CONFIG_README.md` 详细说明配置文件使用方法。

2025-09-11: 修复TOKEN信息显示错误
- 修复TOKEN生成器中KeyError错误，使用安全的字典访问方式；
- 在所有TOKEN信息显示处添加错误检查，避免访问不存在的键；
- 使用`.get()`方法提供默认值，提高程序稳定性。

2025-09-11: 修复TOKEN格式解析错误
- 修复MAC地址中的冒号与TOKEN分隔符冲突的问题；
- 生成TOKEN时将MAC地址中的冒号替换为连字符，避免分割错误；
- 解析TOKEN时将连字符替换回冒号，恢复原始MAC地址格式；
- 确保TOKEN格式始终为3个部分：MAC地址:过期时间:签名。

2025-09-11: 新增手动MAC地址输入功能
- TOKEN管理器中MAC地址改为可编辑输入框，支持手动输入目标MAC地址；
- 新增"本机MAC"按钮，一键填入当前机器MAC地址；
- 新增MAC地址格式验证，确保输入格式正确（XX:XX:XX:XX:XX:XX）；
- 支持为不同机器生成TOKEN，实现集中管理和使用周期控制。

2025-09-11: 修复界面布局问题
- 修复TOKEN管理器中按钮被滚动文本框覆盖的问题；
- 将按钮框架独立于滚动文本框，确保按钮始终可见；
- 调整滚动文本框高度为8行，优化界面布局；
- 确保"生成TOKEN"和"复制TOKEN"按钮正常显示和点击。

2025-09-11: 新增末端目录功能
- 在界面添加"末端目录(可选)"输入框，支持自定义输出路径结构；
- 无末端目录时：项目名称/集数/角色/日期/图片.JPG；
- 有末端目录时：项目名称/集数/角色/末端目录/日期/图片.JPG；
- 更新占位符提示信息，说明新的路径结构；
- 调整界面布局，确保新输入框合理显示。

2025-09-11: 完善末端目录功能
- 修改图片扫描逻辑，支持从末端目录中读取图片；
- 无末端目录时：扫描 项目名称/集数/角色名称/图片.JPG；
- 有末端目录时：扫描 项目名称/集数/角色名称/末端目录/图片.JPG；
- 更新完成目录检查逻辑，正确处理末端目录结构；
- 修正路径解析逻辑，确保项目目录、集数目录、角色目录正确识别；
- 完善占位符提示，说明图片扫描和输出路径的对应关系。

2025-09-11: 修复文件路径错误问题
- 添加文件存在性检查，避免处理不存在的文件；
- 规范化路径处理，确保使用正确的路径分隔符；
- 在文件移动前再次检查源文件是否存在；
- 改进错误处理，提供更详细的错误信息；
- 修复"系统找不到指定的文件"错误，提高程序稳定性。

